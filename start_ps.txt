# Set a unique window title
$host.ui.RawUI.WindowTitle = "HighCPULogger"

# Save the current process ID
$pid | Out-File "$env:USERPROFILE\Desktop\HighCPULogger.pid"

# Set CPU threshold
$cpuThreshold = 80
$logFile = "$env:USERPROFILE\Desktop\HighCPU_Log.csv"

# Write header if log doesn't exist
if (!(Test-Path $logFile)) {
    "Timestamp,ProcessName,ProcessID,CPU" | Out-File $logFile
}

# Monitor loop
while ($true) {
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $processes = Get-CimInstance Win32_PerfFormattedData_PerfProc_Process | Where-Object {
        [int]$_.PercentProcessorTime -gt $cpuThreshold -and $_.Name -ne "_Total" -and $_.Name -ne "Idle"
    }

    foreach ($proc in $processes) {
        "$timestamp,$($proc.Name),$($proc.IDProcess),$($proc.PercentProcessorTime)" | Out-File $logFile -Append
    }

    Start-Sleep -Seconds 10
}